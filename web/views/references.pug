extends layout

mixin reference(ref_str)
  - var match = ref_str.match(/^[\w\d]+/)
  - var abbrev = match ? match[0] : ref_str
  - var ref = references[abbrev]
  if ref
    - var tt = ref.authors.join(', ')
    - if (ref.year) tt += ' (' + ref.year + ')'
    span.reference(data-toggle="tooltip",data-placement="bottom",title=tt)= ref_str
  else
    span.reference= ref_str

block content
  
  h2= title
    if (user)
      button.btn.btn-sm.btn-primary(onclick='actions.add()')
        +icon('plus', 'Add reference')

  table.table.table-striped.table-hover
    thead
      tr
        th Abbreviation
        th Authors
        th Year
        if (user)
          th Actions
    tbody
      for d in data
        tr
          td
            strong= d.abbrev
          td= d.authors
          td= d.year
          if (user)
            td
              a.btn.btn-xs.btn-warning(onclick='actions.edit("'+d._id+'")')
                +icon('pencil', 'Edit')
              |   
              a.btn.btn-xs.btn-danger(onclick='actions.delete("'+d._id+'")')
                +icon('remove', 'Delete')

  .modal(tabindex='-1', role='dialog')
    .modal-dialog(role='document')
      .modal-content
        .modal-header
          button.close(type='button', data-dismiss='modal', aria-label='Close')
            span(aria-hidden='true') Ã—
          h4.modal-title ...
        .modal-body
          div#editor-holder
        .modal-footer
          button.btn.btn-default(type='button', data-dismiss='modal') Close
          button.btn.btn-success(type='button') Save

  script.
    var handle_error = function (err) {
      alert(err.statusText + "\n" + err.responseJSON.name + "\n" + err.responseJSON.err)
    }
    $('button[type=submit]').click(function () {
      var data = {
        abbrev: $('input[name=abbrev]').val(),
        authors: $('input[name=authors]').val().split(';').map((s)=>{return s.trim()}),
        year: $('input[name=year]').val(),
      }
      data.order = parseInt(data.order)
      if (!data.comment) delete(data.comment)
      $.ajax({
        method: "POST",
        contentType: 'application/json',
        url: "#{baseURL}/references/",
        data: JSON.stringify(data),
        success: function (data) {
          window.location.reload()
        },
        error: handle_error,
      })
      return false
    })
    JSONEditor.defaults.options.ajax = true
    JSONEditor.defaults.options.theme = 'bootstrap3'
    JSONEditor.defaults.options.iconlib = 'bootstrap3'
    var actions = {
      add: function() {
        $('h4.modal-title').text('Add reference')
        $('.modal').modal()
        var element = document.getElementById('editor-holder')
        var editor = new JSONEditor(element, {
          schema: !{schema}
        })
      },
      edit: function (id) {
        $('h4.modal-title').text('Edit reference')
        $('.modal').modal()
        $.ajax({
          method: "GET",
          url: "#{baseURL}/references/" + id,
          success: function (data) {
            var element = document.getElementById('editor-holder')
            var editor = new JSONEditor(element, {
              schema: !{schema}
            })
            editor.setValue(data)
          },
          error: handle_error,
        })
        return false
      },
      copy: function (id) {
        $.ajax({
          method: "GET",
          url: "#{baseURL}/references/" + id,
          success: function (data) {
            for (var field of ['abbrev','authors','year']) {
              $('[name="'+field+'"]').val(data[field])
            }
            $('html, body').animate({
                scrollTop: 0
            }, 'fast');
          },
          error: handle_error,
        })
        return false
      },
      delete: function (id) {
        $.ajax({
          method: "DELETE",
          url: "#{baseURL}/references/" + id,
          success: function (data) {
            window.location.reload()
          },
          error: handle_error,
        })
        return false
      },
    }
